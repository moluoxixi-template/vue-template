/**
 * Vite 配置文件
 * 基于 @moluoxixi/vite-config 的配置
 * 
 * 架构说明：
 * - 配置拼装模式（Configuration Assembly Pattern）
 * - 插件和配置片段在 template-data.ts 中预处理
 * - 模板只负责占位符填充，无复杂逻辑
 */

import path from 'node:path'
import process from 'node:process'
import cssModuleGlobalRootPlugin from '@moluoxixi/css-module-global-root-plugin'
import { ViteConfig, wrapperEnv } from '@moluoxixi/vite-config'
<% if (vite.imports.length > 0) { -%>
<%- vite.imports.join('\n') %>
<% } -%>
import { loadEnv } from 'vite'

export default ViteConfig(
  ({ mode }) => {
    const env = loadEnv(mode!, process.cwd())
    const viteEnv = wrapperEnv(env)
    const rootPath = path.resolve()
    const appCode = viteEnv.VITE_APP_CODE
    const appTitle = viteEnv.VITE_APP_TITLE
    const port = viteEnv.VITE_APP_PORT
    return {
      rootPath,
      appTitle,
      appCode,
      port,
      vue: false,
      react: true,
      // 自动组件导入（React 不需要）
      autoComponent: false,
      autoImport: false,
<% if (config.routeMode === 'file-system') { -%>
      // 文件系统路由（基于 vite-plugin-pages）
      pageRoutes: true,
<% } -%>
      viteConfig: {
        plugins: [
<% if (vite.plugins.length > 0) { -%>
<%- vite.plugins.map((plugin, index) => 
  `          ${plugin}${index < vite.plugins.length - 1 ? ',' : ''}`
).join('\n') %>
<% } -%>
        ],
        server: {
          proxy: {
            // 代理配置示例（可根据实际需求修改）
            '/api': {
              changeOrigin: true,
              target: 'http://localhost:3000',
            },
          },
        },
        css: {
          postcss: {
            plugins: [
              cssModuleGlobalRootPlugin,
            ],
          },
<% if (vite.config.css && vite.config.css.preprocessorOptions) { -%>
          preprocessorOptions: <%- JSON.stringify(vite.config.css.preprocessorOptions, null, 12).replace(/^/gm, '            ').replace(/"/g, "'") %>
<% } else { -%>
          preprocessorOptions: {
            scss: {
              silenceDeprecations: ['legacy-js-api'],
              api: 'modern-compiler',
            },
          },
<% } -%>
        },
      },
    }
  },
)

