/**
 * Vite 配置文件
 * 基于 @moluoxixi/vite-config 的配置
 */

import path from 'node:path';
import process from 'node:process';
import cssModuleGlobalRootPlugin from '@moluoxixi/css-module-global-root-plugin';
import { ViteConfig, wrapperEnv } from '@moluoxixi/vite-config';
<%_ for (const [identifier, modulePath] of viteImports) { _%>
import { <%- identifier %> } from '<%- modulePath %>';
<%_ } _%>
import { loadEnv } from 'vite';

export default ViteConfig(
  ({ mode }) => {
    const env = loadEnv(mode!, process.cwd());
    const viteEnv = wrapperEnv(env);
    const rootPath = path.resolve();
    const appCode = viteEnv.VITE_APP_CODE;
    const appTitle = viteEnv.VITE_APP_TITLE;
    const port = viteEnv.VITE_APP_PORT;
    return {
      rootPath,
      appTitle,
      appCode,
      port,
      vue: true,
      // 自动组件导入
      autoComponent: true,
<%_ if (isPageRoutes) { _%>
      // 文件系统路由（基于 vite-plugin-pages）
      pageRoutes: true,
<%_ } _%>
      viteConfig: {
        plugins: [
<%_ for (const plugin of vitePlugins) { _%>
          <%- plugin %>,
<%_ } _%>
        ],
        server: {
          proxy: {
            // 代理配置示例（可根据实际需求修改）
            '/api': {
              changeOrigin: true,
              target: 'http://localhost:3000',
            },
          },
        },
        css: {
          postcss: {
            plugins: [
              cssModuleGlobalRootPlugin,
            ],
          },
          preprocessorOptions: {
            scss: {
              silenceDeprecations: ['legacy-js-api'],
              api: 'modern-compiler',
<%_ if (isElementPlus) { _%>
              additionalData: (source: string, filename: string) => {
                if (filename.includes('assets/styles/element/index.scss')) {
                  return `$namespace: '${appCode || 'el'}';
                ${source}`;
                }
                return source;
              },
<%_ } _%>
            },
          },
        },
      },
    };
  },
);

