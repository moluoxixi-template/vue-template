/**
 * 路由配置（手动路由模式）
 * 手动定义路由配置
 */

import { cloneDeep } from 'lodash-es'
import { assign, isEmpty } from 'radash'
import routes from './routes'
<% if (config.qiankun) { %>
import { qiankunWindow } from 'vite-plugin-qiankun/dist/helper'
<% } %>
import { createRouter, createWebHistory } from 'vue-router'

/**
 * 路由配置
 */
const Routes = [
  ...routes,
  {
    path: '/:pathMatch(.*)*',
    redirect: '/',
  },
]

/**
 * 获取路由实例
 * @param props qiankun props（可选）
 * @returns 路由实例
 */
function getRouter(props: any = {}) {
  let base: string
  const routes = cloneDeep(Routes)

  <% if (config.qiankun) { %>
  // qiankun 微前端模式
  if (qiankunWindow.__POWERED_BY_QIANKUN__) {
    const { activeRule } = props.data
    base = activeRule
  }
  else {
    base = import.meta.env.VITE_APP_CODE || ''
  }
  <% } else { %>
  // 独立运行模式
  base = import.meta.env.VITE_APP_CODE || ''
  <% } %>

  const router = createRouter({
    history: createWebHistory(base),
    routes,
  })

  // 路由守卫
  router.beforeEach((_, from, next) => {
    if (isEmpty(history.state.current)) {
      assign(history.state, { current: from.fullPath })
    }
    next()
  })

  return router
}

export default getRouter

