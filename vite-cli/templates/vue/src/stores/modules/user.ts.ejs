/**
 * 用户状态管理
 * 管理用户信息、登录状态等
 */

import { defineStore } from 'pinia'
import { ref } from 'vue'
import { login, getUserInfo } from '@/apis'
import { store } from '@/stores'

export const userStore = defineStore(
  'user',
  () => {
    // 用户 token
    const token = ref('')
    // 用户信息
    const userInfo = ref<any>(null)

    /**
     * 用户登录
     * @param username 用户名
     * @param password 密码
     */
    async function userLogin(username: string, password: string) {
      try {
        const res = await login({ username, password })
        token.value = res.data.token
        userInfo.value = res.data.userInfo
        return res
      }
      catch (error) {
        console.error('Login failed:', error)
        throw error
      }
    }

    /**
     * 获取用户信息
     */
    async function fetchUserInfo() {
      try {
        const res = await getUserInfo()
        userInfo.value = res.data
        return res
      }
      catch (error) {
        console.error('Get user info failed:', error)
        throw error
      }
    }

    /**
     * 获取 token
     * @returns token
     */
    function getToken() {
      return token.value
    }

    /**
     * 退出登录
     */
    function logout() {
      token.value = ''
      userInfo.value = null
    }

    return {
      token,
      userInfo,
      userLogin,
      fetchUserInfo,
      getToken,
      logout,
    }
  },
  {
    persist: true,
  },
)

export function useUserStore() {
  return userStore(store)
}
