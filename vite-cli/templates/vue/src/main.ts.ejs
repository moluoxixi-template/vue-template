/**
 * 应用入口文件
 * 初始化 Vue 应用并挂载到 DOM
 */

<% if (config.qiankun) { -%>
import type { QiankunProps } from 'vite-plugin-qiankun/dist/helper'
import { qiankunWindow, renderWithQiankun } from 'vite-plugin-qiankun/dist/helper'
<% } -%>
import { createApp } from 'vue'
import directives from '@/directives'
<% if (config.i18n) { -%>
import i18n from '@/locales'
<% } -%>
import { store } from '@/stores'
<% if (config.sentry) { -%>
import { initSentry } from '@/utils/sentry'
<% } -%>
import App from './App.vue'
import getRouter from './router'

// 导入样式文件
import '@/assets/styles/main.scss'
<% if (isElementPlus) { -%>
import '@/assets/styles/element/index.scss'
<% } else if (isAntDesignVue) { -%>
import 'ant-design-vue/dist/reset.css'
<% } -%>
import '@/assets/fonts/index.css'

let app: any

<% if (config.qiankun) { -%>
/**
 * 渲染应用（支持 qiankun 微前端）
 * @param props qiankun 传递的 props
 */
async function render(props: QiankunProps = {}) {
  const { container } = props
  app = createApp(App)
  
  // 注册指令
  directives(app)

  const router = getRouter(props)

<% if (config.sentry) { -%>
  // 初始化 Sentry（生产环境标准配置）
  initSentry(app, router)

<% } -%>
  app.use(store)
<% if (config.i18n) { -%>
  app.use(i18n)
<% } -%>
  app.use(router)
  app.config.warnHandler = () => null

  if (container) {
    const root = container.querySelector('#app')
    app.mount(root)
  }
  else {
    app.mount('#app')
  }
}

// 独立运行时
if (!qiankunWindow.__POWERED_BY_QIANKUN__) {
  render({}).then()
}
else {
  renderWithQiankun({
    async mount(props: QiankunProps) {
      await render(props)
    },
    bootstrap() {
      // qiankun 启动钩子
    },
    unmount() {
      app?.unmount()
      app = null
    },
    update() {
      // qiankun 更新钩子
    },
  })
}
<% } else { -%>
/**
 * 独立运行模式
 */
app = createApp(App)

// 注册指令
directives(app)

const router = getRouter({})

<% if (config.sentry) { -%>
// 初始化 Sentry（生产环境标准配置）
initSentry(app, router)

<% } -%>
app.use(store)
<% if (config.i18n) { -%>
app.use(i18n)
<% } -%>
app.use(router)
app.config.warnHandler = () => null

app.mount('#app')
<% } -%>
