/**
 * æµ‹è¯•è„šæœ¬
 * åŒæ—¶ç”Ÿæˆ Vue å’Œ React æµ‹è¯•é¡¹ç›®ï¼Œå¯ç”¨æ‰€æœ‰åŠŸèƒ½
 */

import type { ProjectConfig } from './types/index.ts'
import { execSync } from 'node:child_process'
import * as process from 'node:process'
import fs from 'fs-extra'
import { generateProject } from './generators/project'

/**
 * è·å–æµ‹è¯•ç›®å½•è·¯å¾„
 */
const testDir = `${process.cwd().replace(/vite-cli$/, '')}vite-cli-test`

/**
 * Vue æµ‹è¯•é…ç½®ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
 */
const vueTestConfig: ProjectConfig = {
  projectName: 'vue',
  description: 'Vue test project generated by vite-cli',
  author: 'vite-cli',
  framework: 'vue',
  uiLibrary: 'element-plus',
  routeMode: 'file-system',
  i18n: true,
  qiankun: true,
  sentry: true,
  packageManager: 'pnpm',
  targetDir: `${testDir}/vue`,
}

/**
 * React æµ‹è¯•é…ç½®ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
 */
const reactTestConfig: ProjectConfig = {
  projectName: 'react',
  description: 'React test project generated by vite-cli',
  author: 'vite-cli',
  framework: 'react',
  uiLibrary: 'ant-design',
  routeMode: 'file-system',
  i18n: true,
  qiankun: true,
  sentry: true,
  packageManager: 'pnpm',
  targetDir: `${testDir}/react`,
}

/**
 * æ¸…ç©ºæµ‹è¯•ç›®å½•
 */
function cleanTestDir(): void {
  console.log('ğŸ§¹ Cleaning test directory...')
  if (fs.existsSync(testDir)) {
    try {
      // å°è¯•ä½¿ç”¨ fs-extra åˆ é™¤
      fs.removeSync(testDir)
      console.log(`   Removed: ${testDir}`)
    }
    catch {
      // å¦‚æœ fs-extra å¤±è´¥ï¼Œä½¿ç”¨ç³»ç»Ÿå‘½ä»¤å¼ºåˆ¶åˆ é™¤ï¼ˆWindowsï¼‰
      console.log('   Using system command to remove directory...')
      try {
        execSync(`rd /s /q "${testDir}"`, { stdio: 'ignore', shell: 'cmd.exe' })
        console.log(`   Removed: ${testDir}`)
      }
      catch {
        console.warn('   Warning: Could not fully clean directory, will overwrite files')
      }
    }
  }
  fs.ensureDirSync(testDir)
  console.log('âœ… Test directory cleaned!\n')
}

/**
 * å®‰è£…é¡¹ç›®ä¾èµ–
 * @param projectDir é¡¹ç›®ç›®å½•
 * @param projectName é¡¹ç›®åç§°
 */
function installDependencies(projectDir: string, projectName: string): void {
  console.log(`ğŸ“¦ Installing dependencies for ${projectName}...`)
  try {
    execSync('pnpm install', {
      cwd: projectDir,
      stdio: 'inherit',
    })
    console.log(`âœ… ${projectName} dependencies installed!\n`)
  }
  catch (error) {
    console.error(`âŒ Failed to install dependencies for ${projectName}`)
    throw error
  }
}

/**
 * è¿è¡Œé¡¹ç›®å¼€å‘æœåŠ¡å™¨æµ‹è¯•
 * @param projectDir é¡¹ç›®ç›®å½•
 * @param projectName é¡¹ç›®åç§°
 */
function testDevServer(projectDir: string, projectName: string): void {
  console.log(`ğŸš€ Testing ${projectName} dev server (will start and stop)...`)
  try {
    // ä½¿ç”¨ type-check æ¥éªŒè¯ TypeScript ç¼–è¯‘
    execSync('pnpm type-check', {
      cwd: projectDir,
      stdio: 'inherit',
    })
    console.log(`âœ… ${projectName} type-check passed!\n`)
  }
  catch (error) {
    console.error(`âŒ ${projectName} type-check failed`)
    throw error
  }
}

/**
 * è¿è¡Œæµ‹è¯•
 */
async function runTest() {
  try {
    console.log('ğŸš€ Starting test project generation...\n')

    // æ¸…ç©ºæµ‹è¯•ç›®å½•
    cleanTestDir()

    // ç”Ÿæˆ Vue é¡¹ç›®
    console.log('ğŸ“¦ Generating Vue project...')
    console.log('Configuration:')
    console.log(`  Framework: ${vueTestConfig.framework}`)
    console.log(`  UI Library: ${vueTestConfig.uiLibrary}`)
    console.log(`  Route Mode: ${vueTestConfig.routeMode}`)
    console.log(`  i18n: ${vueTestConfig.i18n}`)
    console.log(`  Qiankun: ${vueTestConfig.qiankun}`)
    console.log(`  Sentry: ${vueTestConfig.sentry}`)
    console.log(`  Target: ${vueTestConfig.targetDir}\n`)

    await generateProject(vueTestConfig)
    console.log('âœ… Vue project generated successfully!\n')

    // ç”Ÿæˆ React é¡¹ç›®
    console.log('ğŸ“¦ Generating React project...')
    console.log('Configuration:')
    console.log(`  Framework: ${reactTestConfig.framework}`)
    console.log(`  UI Library: ${reactTestConfig.uiLibrary}`)
    console.log(`  Route Mode: ${reactTestConfig.routeMode}`)
    console.log(`  i18n: ${reactTestConfig.i18n}`)
    console.log(`  Qiankun: ${reactTestConfig.qiankun}`)
    console.log(`  Sentry: ${reactTestConfig.sentry}`)
    console.log(`  Target: ${reactTestConfig.targetDir}\n`)

    await generateProject(reactTestConfig)
    console.log('âœ… React project generated successfully!\n')

    console.log('ğŸ‰ All test projects generated successfully!')
    console.log(`\nğŸ“ Vue project: ${vueTestConfig.targetDir}`)
    console.log(`ğŸ“ React project: ${reactTestConfig.targetDir}`)

    // å®‰è£…ä¾èµ–å¹¶æµ‹è¯•
    console.log(`\n${'='.repeat(50)}`)
    console.log('ğŸ“¦ Installing dependencies and testing...')
    console.log(`${'='.repeat(50)}\n`)

    // å®‰è£… Vue é¡¹ç›®ä¾èµ–
    installDependencies(vueTestConfig.targetDir, 'Vue')

    // å®‰è£… React é¡¹ç›®ä¾èµ–
    installDependencies(reactTestConfig.targetDir, 'React')

    // æµ‹è¯• Vue é¡¹ç›®
    testDevServer(vueTestConfig.targetDir, 'Vue')

    // æµ‹è¯• React é¡¹ç›®
    testDevServer(reactTestConfig.targetDir, 'React')

    console.log(`\n${'='.repeat(50)}`)
    console.log('ğŸ‰ All tests passed!')
    console.log('='.repeat(50))
  }
  catch (error) {
    console.error('\nâŒ Error:', error)
    process.exit(1)
  }
}

runTest()
