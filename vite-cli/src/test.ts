/**
 * æµ‹è¯•è„šæœ¬
 * ç”Ÿæˆ Vue (Element Plus / Ant Design Vue) å’Œ React (Ant Design) æµ‹è¯•é¡¹ç›®ï¼Œå¯ç”¨æ‰€æœ‰åŠŸèƒ½
 */

import type { ProjectConfig } from './types'
import { execSync } from 'node:child_process'
import { join } from 'node:path'
import process from 'node:process'
import fs from 'fs-extra'
import { generateProject } from './generators/project'

/**
 * è·å–æµ‹è¯•ç›®å½•è·¯å¾„
 */
const testDir = `${process.cwd().replace(/vite-cli$/, '')}vite-cli-test`

/**
 * Vue + Element Plus æµ‹è¯•é…ç½®ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
 */
const vueElementConfig: ProjectConfig = {
  projectName: 'vue-element',
  description: 'Vue + Element Plus test project generated by vite-cli',
  author: 'vite-cli',
  framework: 'vue',
  uiLibrary: 'element-plus',
  routeMode: 'file-system',
  i18n: true,
  qiankun: true,
  sentry: true,
  packageManager: 'pnpm',
  targetDir: `${testDir}/vue-element`,
}

/**
 * Vue + Ant Design Vue æµ‹è¯•é…ç½®ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
 */
const vueAntdConfig: ProjectConfig = {
  projectName: 'vue-antd',
  description: 'Vue + Ant Design Vue test project generated by vite-cli',
  author: 'vite-cli',
  framework: 'vue',
  uiLibrary: 'ant-design-vue',
  routeMode: 'file-system',
  i18n: true,
  qiankun: true,
  sentry: true,
  packageManager: 'pnpm',
  targetDir: `${testDir}/vue-antd`,
}

/**
 * React + Ant Design æµ‹è¯•é…ç½®ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
 */
const reactAntdConfig: ProjectConfig = {
  projectName: 'react-antd',
  description: 'React + Ant Design test project generated by vite-cli',
  author: 'vite-cli',
  framework: 'react',
  uiLibrary: 'ant-design',
  routeMode: 'file-system',
  i18n: true,
  qiankun: true,
  sentry: true,
  packageManager: 'pnpm',
  targetDir: `${testDir}/react-antd`,
}

/**
 * æ¸…ç©ºæµ‹è¯•ç›®å½•ï¼ˆä»…æ¸…ç©ºå†…å®¹ï¼Œä¿ç•™ç›®å½•ï¼‰
 */
function cleanTestDir(): void {
  console.log('ğŸ§¹ Cleaning test directory...')

  // ç¡®ä¿ç›®å½•å­˜åœ¨
  fs.ensureDirSync(testDir)

  // è¯»å–ç›®å½•å†…å®¹
  const entries = fs.readdirSync(testDir)

  if (entries.length === 0) {
    console.log('   Directory is already empty')
    console.log('âœ… Test directory cleaned!\n')
    return
  }

  // æ¸…ç©ºç›®å½•å†…å®¹
  console.log(`   Removing ${entries.length} item(s)...`)
  for (const entry of entries) {
    const entryPath = join(testDir, entry)
    try {
      const stat = fs.statSync(entryPath)
      if (stat.isDirectory()) {
        fs.removeSync(entryPath)
      }
      else {
        fs.unlinkSync(entryPath)
      }
    }
    catch (error) {
      console.warn(`   Warning: Could not remove ${entry},error: ${error}, will continue...`)
    }
  }

  console.log('âœ… Test directory cleaned!\n')
}

/**
 * å®‰è£…é¡¹ç›®ä¾èµ–
 * @param projectDir é¡¹ç›®ç›®å½•
 * @param projectName é¡¹ç›®åç§°
 */
function installDependencies(projectDir: string, projectName: string): void {
  console.log(`ğŸ“¦ Installing dependencies for ${projectName}...`)
  try {
    execSync('pnpm install', {
      cwd: projectDir,
      stdio: 'inherit',
    })
    console.log(`âœ… ${projectName} dependencies installed!\n`)
  }
  catch (error) {
    console.error(`âŒ Failed to install dependencies for ${projectName}`)
    throw error
  }
}

/**
 * è¿è¡Œé¡¹ç›®ç±»å‹æ£€æŸ¥
 * @param projectDir é¡¹ç›®ç›®å½•
 * @param projectName é¡¹ç›®åç§°
 */
function testTypeCheck(projectDir: string, projectName: string): void {
  console.log(`ğŸš€ Testing ${projectName} type-check...`)
  try {
    execSync('pnpm type-check', {
      cwd: projectDir,
      stdio: 'inherit',
    })
    console.log(`âœ… ${projectName} type-check passed!\n`)
  }
  catch (error) {
    console.error(`âŒ ${projectName} type-check failed`)
    throw error
  }
}

/**
 * ç”Ÿæˆå•ä¸ªé¡¹ç›®
 * @param config é¡¹ç›®é…ç½®
 * @param name é¡¹ç›®æ˜¾ç¤ºåç§°
 */
async function generateSingleProject(config: ProjectConfig, name: string): Promise<void> {
  console.log(`ğŸ“¦ Generating ${name} project...`)
  console.log('Configuration:')
  console.log(`  Framework: ${config.framework}`)
  console.log(`  UI Library: ${config.uiLibrary}`)
  console.log(`  Route Mode: ${config.routeMode}`)
  console.log(`  i18n: ${config.i18n}`)
  console.log(`  Qiankun: ${config.qiankun}`)
  console.log(`  Sentry: ${config.sentry}`)
  console.log(`  Target: ${config.targetDir}\n`)

  await generateProject(config)
  console.log(`âœ… ${name} project generated successfully!\n`)
}

/**
 * è¿è¡Œæµ‹è¯•
 */
async function runTest() {
  try {
    console.log('ğŸš€ Starting test project generation...\n')

    // æ¸…ç©ºæµ‹è¯•ç›®å½•
    cleanTestDir()

    // ç”Ÿæˆæ‰€æœ‰é¡¹ç›®
    await generateSingleProject(vueElementConfig, 'Vue + Element Plus')
    await generateSingleProject(vueAntdConfig, 'Vue + Ant Design Vue')
    await generateSingleProject(reactAntdConfig, 'React + Ant Design')

    console.log('ğŸ‰ All test projects generated successfully!')
    console.log(`\nğŸ“ Vue + Element Plus: ${vueElementConfig.targetDir}`)
    console.log(`ğŸ“ Vue + Ant Design Vue: ${vueAntdConfig.targetDir}`)
    console.log(`ğŸ“ React + Ant Design: ${reactAntdConfig.targetDir}`)

    // å®‰è£…ä¾èµ–å¹¶æµ‹è¯•
    console.log(`\n${'='.repeat(50)}`)
    console.log('ğŸ“¦ Installing dependencies and testing...')
    console.log(`${'='.repeat(50)}\n`)

    // å®‰è£…æ‰€æœ‰é¡¹ç›®ä¾èµ–
    installDependencies(vueElementConfig.targetDir, 'Vue + Element Plus')
    installDependencies(vueAntdConfig.targetDir, 'Vue + Ant Design Vue')
    installDependencies(reactAntdConfig.targetDir, 'React + Ant Design')

    // æµ‹è¯•æ‰€æœ‰é¡¹ç›®
    testTypeCheck(vueElementConfig.targetDir, 'Vue + Element Plus')
    testTypeCheck(vueAntdConfig.targetDir, 'Vue + Ant Design Vue')
    testTypeCheck(reactAntdConfig.targetDir, 'React + Ant Design')

    console.log(`\n${'='.repeat(50)}`)
    console.log('ğŸ‰ All tests passed!')
    console.log('='.repeat(50))
  }
  catch (error) {
    console.error('\nâŒ Error:', error)
    process.exit(1)
  }
}

runTest()
